<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Barista Cafe - Admin Panel</title>
    
    <!-- CSS FILES -->
    <link href="2137_barista_cafe/css/bootstrap.min.css" rel="stylesheet">
    <link href="2137_barista_cafe/css/bootstrap-icons.css" rel="stylesheet">
    <link href="2137_barista_cafe/css/tooplate-barista.css" rel="stylesheet">
    
    <style>
        .admin-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px 0;
        }
        .admin-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
        }
        .status-badge {
            font-size: 0.8rem;
            padding: 0.3rem 0.8rem;
        }
        .booking-card {
            border-left: 4px solid #007bff;
            transition: all 0.3s ease;
        }
        .booking-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        .stats-card {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <div class="container">
            <!-- Header -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="admin-card p-4">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h1 class="text-primary mb-0">
                                    <i class="bi bi-cup-hot-fill me-2"></i>
                                    Barista Cafe Admin
                                </h1>
                                <p class="text-muted mb-0">Booking Management System</p>
                            </div>
                            <div>
                                <button class="btn btn-outline-primary" onclick="refreshBookings()">
                                    <i class="bi bi-arrow-clockwise me-1"></i>
                                    Refresh
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="row mb-4" id="statsRow">
                <div class="col-md-3 col-6 mb-3">
                    <div class="stats-card p-3 text-center">
                        <h3 class="mb-1" id="totalBookings">-</h3>
                        <small>Total Bookings</small>
                    </div>
                </div>
                <div class="col-md-3 col-6 mb-3">
                    <div class="stats-card p-3 text-center">
                        <h3 class="mb-1" id="pendingBookings">-</h3>
                        <small>Pending</small>
                    </div>
                </div>
                <div class="col-md-3 col-6 mb-3">
                    <div class="stats-card p-3 text-center">
                        <h3 class="mb-1" id="confirmedBookings">-</h3>
                        <small>Confirmed</small>
                    </div>
                </div>
                <div class="col-md-3 col-6 mb-3">
                    <div class="stats-card p-3 text-center">
                        <h3 class="mb-1" id="todayBookings">-</h3>
                        <small>Today</small>
                    </div>
                </div>
            </div>

            <!-- Filters -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="admin-card p-3">
                        <div class="row align-items-center">
                            <div class="col-md-3 col-12 mb-2">
                                <label class="form-label">Status Filter:</label>
                                <select class="form-select" id="statusFilter">
                                    <option value="">All Statuses</option>
                                    <option value="pending">Pending</option>
                                    <option value="confirmed">Confirmed</option>
                                    <option value="cancelled">Cancelled</option>
                                    <option value="completed">Completed</option>
                                </select>
                            </div>
                            <div class="col-md-3 col-12 mb-2">
                                <label class="form-label">Date Filter:</label>
                                <input type="date" class="form-control" id="dateFilter">
                            </div>
                            <div class="col-md-3 col-12 mb-2">
                                <label class="form-label">Search:</label>
                                <input type="text" class="form-control" id="searchInput" placeholder="Search by name or phone">
                            </div>
                            <div class="col-md-3 col-12 mb-2">
                                <button class="btn btn-primary w-100" onclick="applyFilters()">
                                    <i class="bi bi-funnel me-1"></i>
                                    Apply Filters
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bookings List -->
            <div class="row">
                <div class="col-12">
                    <div class="admin-card p-4">
                        <h4 class="mb-3">
                            <i class="bi bi-calendar-check me-2"></i>
                            Bookings
                        </h4>
                        <div id="bookingsList">
                            <div class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2 text-muted">Loading bookings...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Update Modal -->
    <div class="modal fade" id="statusModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Update Booking Status</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Booking ID: <strong id="modalBookingId"></strong></p>
                    <p>Customer: <strong id="modalCustomerName"></strong></p>
                    <p>Date & Time: <strong id="modalDateTime"></strong></p>
                    
                    <label class="form-label">New Status:</label>
                    <select class="form-select" id="newStatus">
                        <option value="pending">Pending</option>
                        <option value="confirmed">Confirmed</option>
                        <option value="cancelled">Cancelled</option>
                        <option value="completed">Completed</option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="updateBookingStatus()">Update Status</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="2137_barista_cafe/js/jquery.min.js"></script>
    <script src="2137_barista_cafe/js/bootstrap.min.js"></script>
    
    <script>
        const API_BASE_URL = 'http://localhost:3000/api';
        let currentBookings = [];
        let currentBookingId = null;

        $(document).ready(function() {
            loadBookings();
            
            // Auto-refresh every 30 seconds
            setInterval(loadBookings, 30000);
        });

        async function loadBookings() {
            try {
                const response = await fetch(`${API_BASE_URL}/bookings`);
                const bookings = await response.json();
                
                currentBookings = bookings;
                displayBookings(bookings);
                updateStats(bookings);
                
            } catch (error) {
                console.error('Error loading bookings:', error);
                $('#bookingsList').html(`
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Failed to load bookings. Please check your connection.
                    </div>
                `);
            }
        }

        function displayBookings(bookings) {
            if (bookings.length === 0) {
                $('#bookingsList').html(`
                    <div class="text-center py-4">
                        <i class="bi bi-calendar-x text-muted" style="font-size: 3rem;"></i>
                        <p class="text-muted mt-2">No bookings found</p>
                    </div>
                `);
                return;
            }

            const bookingsHtml = bookings.map(booking => {
                const statusClass = getStatusClass(booking.status);
                const bookingDate = new Date(booking.booking_date).toLocaleDateString();
                const bookingTime = booking.booking_time;
                
                return `
                    <div class="booking-card card mb-3">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-3 col-12">
                                    <h6 class="mb-1">${booking.customer_name}</h6>
                                    <small class="text-muted">${booking.phone}</small>
                                </div>
                                <div class="col-md-2 col-6">
                                    <small class="text-muted">Date</small>
                                    <div>${bookingDate}</div>
                                </div>
                                <div class="col-md-2 col-6">
                                    <small class="text-muted">Time</small>
                                    <div>${bookingTime}</div>
                                </div>
                                <div class="col-md-2 col-6">
                                    <small class="text-muted">People</small>
                                    <div>${booking.number_of_people}</div>
                                </div>
                                <div class="col-md-2 col-6">
                                    <span class="badge status-badge ${statusClass}">${booking.status}</span>
                                </div>
                                <div class="col-md-1 col-12 text-end">
                                    <button class="btn btn-sm btn-outline-primary" onclick="openStatusModal(${booking.id}, '${booking.customer_name}', '${bookingDate} ${bookingTime}', '${booking.status}')">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                </div>
                            </div>
                            ${booking.special_requests ? `
                                <div class="row mt-2">
                                    <div class="col-12">
                                        <small class="text-muted">Special Requests:</small>
                                        <div class="fst-italic">${booking.special_requests}</div>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            $('#bookingsList').html(bookingsHtml);
        }

        function getStatusClass(status) {
            const classes = {
                'pending': 'bg-warning text-dark',
                'confirmed': 'bg-success',
                'cancelled': 'bg-danger',
                'completed': 'bg-info'
            };
            return classes[status] || 'bg-secondary';
        }

        function updateStats(bookings) {
            const today = new Date().toISOString().split('T')[0];
            
            const stats = {
                total: bookings.length,
                pending: bookings.filter(b => b.status === 'pending').length,
                confirmed: bookings.filter(b => b.status === 'confirmed').length,
                today: bookings.filter(b => b.booking_date === today).length
            };

            $('#totalBookings').text(stats.total);
            $('#pendingBookings').text(stats.pending);
            $('#confirmedBookings').text(stats.confirmed);
            $('#todayBookings').text(stats.today);
        }

        function applyFilters() {
            const statusFilter = $('#statusFilter').val();
            const dateFilter = $('#dateFilter').val();
            const searchTerm = $('#searchInput').val().toLowerCase();

            let filteredBookings = currentBookings;

            if (statusFilter) {
                filteredBookings = filteredBookings.filter(b => b.status === statusFilter);
            }

            if (dateFilter) {
                filteredBookings = filteredBookings.filter(b => b.booking_date === dateFilter);
            }

            if (searchTerm) {
                filteredBookings = filteredBookings.filter(b => 
                    b.customer_name.toLowerCase().includes(searchTerm) ||
                    b.phone.includes(searchTerm)
                );
            }

            displayBookings(filteredBookings);
        }

        function openStatusModal(bookingId, customerName, dateTime, currentStatus) {
            currentBookingId = bookingId;
            $('#modalBookingId').text(bookingId);
            $('#modalCustomerName').text(customerName);
            $('#modalDateTime').text(dateTime);
            $('#newStatus').val(currentStatus);
            
            new bootstrap.Modal(document.getElementById('statusModal')).show();
        }

        async function updateBookingStatus() {
            if (!currentBookingId) return;

            const newStatus = $('#newStatus').val();
            
            try {
                const response = await fetch(`${API_BASE_URL}/bookings/${currentBookingId}/status`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ status: newStatus })
                });

                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('statusModal')).hide();
                    loadBookings(); // Refresh the list
                } else {
                    const error = await response.json();
                    alert('Failed to update status: ' + error.error);
                }
            } catch (error) {
                console.error('Error updating status:', error);
                alert('Failed to update status. Please try again.');
            }
        }

        function refreshBookings() {
            loadBookings();
        }

        // Clear filters
        $('#statusFilter, #dateFilter, #searchInput').on('change keyup', function() {
            if ($(this).val() === '') {
                applyFilters();
            }
        });
    </script>
</body>
</html>
